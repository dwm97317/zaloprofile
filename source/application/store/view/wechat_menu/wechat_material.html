<!-- application/view/wechat_menu/wechat_material.html -->
<div class="row-content am-cf">
    <div class="row">
        <div class="am-u-sm-12 am-u-md-12 am-u-lg-12">
            <div class="widget am-cf">
                <div class="widget-head am-cf">
                    <div class="widget-title am-fl">微信素材选择</div>
                </div>
                <div class="widget-body am-fr">
                    <?php if (isset($error)): ?>
                        <div class="am-alert am-alert-danger"><?= $error ?></div>
                    <?php endif; ?>
                    
                    <div class="am-tabs" data-am-tabs>
                        <ul class="am-tabs-nav am-nav am-nav-tabs">
                            <li class="am-active"><a href="#tab-news">图文素材</a></li>
                            <li><a href="#tab-image">图片素材</a></li>
                            <!-- 其他素材类型标签... -->
                        </ul>
                        
                        <div class="am-tabs-bd">
                            <div class="am-tab-panel am-fade am-in am-active" id="tab-news">
                                <div class="am-scrollable-horizontal">
                                    <table class="am-table am-table-compact am-table-striped tpl-table-black am-text-nowrap">
                                        <thead>
                                            <tr>
                                                <th>选择</th>
                                                <th>标题</th>
                                                <th>更新时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <?php if (!empty($materialList)): ?>
                                                <?php foreach ($materialList as $item): ?>
                                                    <?php if (!empty($item['content']['news_item'])): ?>
                                                        <tr>
                                                            <td>
                                                                <input type="radio" name="selected_material" 
                                                                       value="<?= $item['media_id'] ?>" 
                                                                       data-type="news">
                                                            </td>
                                                            <td>
                                                                <?= htmlspecialchars($item['content']['news_item'][0]['title'] ?? '无标题') ?>
                                                                <?php if (count($item['content']['news_item']) > 1): ?>
                                                                    <span class="am-badge am-badge-secondary">多图文</span>
                                                                <?php endif; ?>
                                                            </td>
                                                            <td><?= date('Y-m-d H:i', $item['update_time']) ?></td>
                                                            <td>
                                                                <button class="am-btn am-btn-xs am-btn-default j-preview" 
                                                                        data-media_id="<?= $item['media_id'] ?>"
                                                                        data-type="news">
                                                                    <i class="am-icon-eye"></i> 预览
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    <?php endif; ?>
                                                <?php endforeach; ?>
                                            <?php else: ?>
                                                <tr>
                                                    <td colspan="4" class="am-text-center">暂无图文素材</td>
                                                </tr>
                                            <?php endif; ?>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- 图片素材标签页 -->
                            <div class="am-tab-panel am-fade" id="tab-image">
                                <div class="am-alert">图片素材功能暂未实现</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="am-margin-top">
                        <button type="button" class="am-btn am-btn-primary am-radius j-confirm">确定选择</button>
                        <button type="button" class="am-btn am-btn-default am-radius j-cancel">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(function() {
    // 设置全局函数供父窗口调用
    window.getSelectedMaterial = function() {
        var selected = $('input[name="selected_material"]:checked');
        if (selected.length > 0) {
            return {
                media_id: selected.val(),
                type: selected.data('type')
            };
        }
        return null;
    };
    
    // 预览素材
    $('.j-preview').on('click', function() {
        var mediaId = $(this).data('media_id');
        var type = $(this).data('type');
        
        layer.open({
            type: 2,
            title: '素材预览',
            content: '{:url("wechat_menu/material_detail")}?media_id=' + mediaId + '&type=' + type,
            area: ['80%', '90%']
        });
    });
    
    // 确定选择
    $('.j-confirm').on('click', function() {
        var selected = getSelectedMaterial();
        if (selected) {
            parent.layer.closeAll();
        } else {
            layer.msg('请选择素材', {icon: 2});
        }
    });
    
    // 取消
    $('.j-cancel').on('click', function() {
        parent.layer.closeAll();
    });
});
</script>
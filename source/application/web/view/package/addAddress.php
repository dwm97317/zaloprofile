 <div class="card">
    <div class="card-header border bottom">
        <h4 class="card-title">Th√™m ƒë·ªãa ch·ªâ ng∆∞·ªùi nh·∫≠n (Vi·ªát Nam)</h4>
        <small class="text-muted">S·ª≠ d·ª•ng t√¨m ki·∫øm ho·∫∑c b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒë·ªãa ch·ªâ ch√≠nh x√°c</small>
    </div>
    <div class="card-body">
        <!-- Âú∞ÂùÄÊêúÁ¥¢ÂíåÂú∞ÂõæÂå∫Âüü -->
        <div class="form-section mb-4" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <h5 class="mb-3">üîç T√¨m ki·∫øm ƒë·ªãa ch·ªâ</h5>
            
            <!-- Âú∞ÂùÄÊêúÁ¥¢Ê°Ü -->
            <div class="form-group">
                <div id="vietnamese-address-autocomplete" class="autocomplete-container">
                    <!-- ÊêúÁ¥¢Ê°ÜÂ∞ÜÁî±JSÁªÑ‰ª∂Âä®ÊÄÅÂàõÂª∫ -->
                </div>
            </div>
            
            <!-- Âú∞ÂõæÂÆπÂô® -->
            <div class="map-container" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                <div style="background: #e9ecef; padding: 10px; border-bottom: 1px solid #ddd;">
                    <strong>üó∫Ô∏è Ch·ªçn v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì</strong>
                    <small class="text-muted ml-2">(Nh·∫•p v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒë·ªãa ch·ªâ ch√≠nh x√°c)</small>
                </div>
                <div id="vietnamese-address-map" style="height: 300px;"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <form role="form" id="vietnameseAddressForm">
                    
                    <!-- Êî∂‰ª∂‰∫∫Âü∫Êú¨‰ø°ÊÅØ -->
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label control-label">H·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n *</label>
                        <div class="col-sm-3">
                            <input type="text" class="form-control" name="address[name]" placeholder="Nh·∫≠p h·ªç v√† t√™n" required="true">
                        </div>
                        
                        <?php if($setting['address_setting']['is_identitycard']) : ?>
                        <label class="col-sm-1 col-form-label control-label">CMND/CCCD</label>
                        <div class="col-sm-3">
                            <input type="text" class="form-control" name="address[identitycard]" placeholder="S·ªë CMND/CCCD">
                        </div>
                        <?php endif; ?>
                        
                        <?php if($setting['address_setting']['is_clearancecode']) : ?>
                        <label class="col-sm-1 col-form-label control-label">M√£ th√¥ng quan</label>
                        <div class="col-sm-2">
                            <input type="text" class="form-control" name="address[clearancecode]" placeholder="M√£ th√¥ng quan">
                        </div>
                        <?php endif; ?>
                    </div>
                    
                    <!-- ËÅîÁ≥ªÊñπÂºè -->
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label control-label">S·ªë ƒëi·ªán tho·∫°i *</label>
                        <?php if($setting['address_setting']['is_tel_code']) : ?>
                        <div class="col-sm-1">
                            <input type="text" class="form-control" name="address[tel_code]" placeholder="+84" value="+84">
                        </div>
                        <?php endif; ?>
                        <div class="col-sm-3">
                            <input type="text" class="form-control" name="address[phone]" placeholder="S·ªë ƒëi·ªán tho·∫°i" required="">
                        </div>
                        <div class="col-sm-2">
                            <input type="hidden" class="form-control" name="address[addressty]" value="0">
                        </div>
                    </div>
                    
                    <!-- Âú∞ÂùÄ‰ø°ÊÅØ - Ë∂äÂçóÊ†áÂáÜÊ†ºÂºè -->
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label control-label">Qu·ªëc gia *</label>
                        <div class="col-sm-2">
                                <select class="form-control" name="address[country_id]">
                                <option value="1" selected>Vi·ªát Nam</option>
                                <?php if (isset($countryList) && !$countryList->isEmpty()):
                                foreach ($countryList as $countryitem): ?>
                                    <option value="<?= $countryitem['id'] ?>" <?= $countryitem['title'] == 'Vi·ªát Nam' ? 'selected' : '' ?>>
                                        <?= $countryitem['title'] ?>
                                    </option>
                                <?php endforeach; endif; ?>
                            </select>
                        </div>
                        
                        <!-- ÁúÅ/Â∏Ç -->
                        <label class="col-sm-1 col-form-label control-label">T·ªânh/TP *</label>
                        <div class="col-sm-2">
                            <input type="text" class="form-control vietnamese-province" name="address[province]" 
                                   placeholder="T·ªânh/Th√†nh ph·ªë" required="" readonly>
                        </div>
                        
                        <!-- Âå∫/Âéø -->
                        <label class="col-sm-1 col-form-label control-label">Qu·∫≠n/Huy·ªán *</label>
                        <div class="col-sm-2">
                            <input type="text" class="form-control vietnamese-district" name="address[city]" 
                                   placeholder="Qu·∫≠n/Huy·ªán" required="" readonly>
                        </div>
                    </div>

                    <div class="form-group row">
                        <!-- Âùä/Á§æ -->
                        <label class="col-sm-2 col-form-label control-label">Ph∆∞·ªùng/X√£ *</label>
                        <div class="col-sm-2">
                            <input type="text" class="form-control vietnamese-ward" name="address[region]" 
                                   placeholder="Ph∆∞·ªùng/X√£" required="" readonly>
                        </div>
                        
                        <!-- Ë°óÈÅì -->
                        <label class="col-sm-1 col-form-label control-label">ƒê∆∞·ªùng/Ph·ªë</label>
                        <div class="col-sm-2">
                            <input type="text" class="form-control vietnamese-street" name="address[street]" 
                                   placeholder="T√™n ƒë∆∞·ªùng/ph·ªë">
                        </div>
                        
                        <!-- Èó®ÁâåÂè∑ -->
                        <label class="col-sm-1 col-form-label control-label">S·ªë nh√†</label>
                        <div class="col-sm-2">
                            <input type="text" class="form-control vietnamese-house-number" name="address[door]" 
                                   placeholder="S·ªë nh√† (VD: 123, 45A)">
                        </div>
                    </div>

                    <!-- ËØ¶ÁªÜÂú∞ÂùÄ -->
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label control-label">ƒê·ªãa ch·ªâ chi ti·∫øt *</label>
                        <div class="col-sm-6">
                            <textarea class="form-control vietnamese-detail" name="address[detail]" rows="3"
                                placeholder="ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn t·ª± ƒë·ªông khi b·∫°n ch·ªçn t·ª´ t√¨m ki·∫øm ho·∫∑c b·∫£n ƒë·ªì" required=""></textarea>
                        </div>
                        
                        <!-- ÈÇÆÁºñ -->
                        <?php if($setting['address_setting']['is_code']) : ?>
                        <label class="col-sm-1 col-form-label control-label">M√£ b∆∞u ƒëi·ªán</label>
                        <div class="col-sm-2">
                            <input type="text" class="form-control" name="address[code]" placeholder="M√£ b∆∞u ƒëi·ªán">
                        </div>
                        <?php endif; ?>
                    </div>

                    <!-- È¢ùÂ§ñ‰ø°ÊÅØ -->
                    <?php if($setting['address_setting']['is_email']) : ?>
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label control-label">Email</label>
                        <div class="col-sm-4">
                            <input type="email" class="form-control" name="address[email]" placeholder="Email (kh√¥ng b·∫Øt bu·ªôc)">
                        </div>
                        </div>
                        <?php endif; ?>
                    
                    <!-- ÈöêËóèÂ≠óÊÆµÂ≠òÂÇ®ÂùêÊ†á -->
                    <input type="hidden" id="latitude" name="address[latitude]">
                    <input type="hidden" id="longitude" name="address[longitude]">
                    
                    <!-- Êèê‰∫§ÊåâÈíÆ -->
                    <div class="form-group row">
                        <div class="col-sm-12">
                            <button type="button" class="btn btn-outline-secondary mr-2" onclick="clearVietnameseAddress()">
                                üóëÔ∏è X√≥a t·∫•t c·∫£
                            </button>
                            <button type="button" class="btn btn-gradient-success address">
                                üíæ L∆∞u ƒë·ªãa ch·ªâ
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Âú∞ÂùÄÈ¢ÑËßà -->
        <div id="vietnamese-address-preview" class="card mt-3" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">üëÅÔ∏è Xem tr∆∞·ªõc ƒë·ªãa ch·ªâ ƒë√£ ch·ªçn</h5>
            </div>
            <div class="card-body">
                <div id="vietnamese-preview-content"></div>
            </div>
        </div>
    </div>
</div>

<!-- Âä†ËΩΩË∂äÂçóÂú∞ÂùÄÁªÑ‰ª∂ -->
<link href="https://cdn.jsdelivr.net/npm/@goongmaps/goong-js@1.0.9/dist/goong-js.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/@goongmaps/goong-js@1.0.9/dist/goong-js.js"></script>
<script src="/html5/vietnamese-address-component.js"></script>

<script>
// Ë∂äÂçóÂú∞ÂùÄÁªÑ‰ª∂
let vietnameseAddressComponent;

$(document).ready(function() {
    // ÂàùÂßãÂåñË∂äÂçóÂú∞ÂùÄÁªÑ‰ª∂
    initVietnameseAddressComponent();
    
    // ÁªëÂÆöË°®ÂçïÊèê‰∫§‰∫ã‰ª∂
    bindFormSubmitEvent();
});

/**
 * ÂàùÂßãÂåñË∂äÂçóÂú∞ÂùÄÁªÑ‰ª∂
 */
function initVietnameseAddressComponent() {
    // ËÆæÁΩÆGoong APIÂØÜÈí•
    if (typeof goongjs !== 'undefined') {
        goongjs.accessToken = '5uo0DOu7oFhOoqtxFhyZemwhmkI0XiFTiq66c0Nj';
    }
    
    // ÂàõÂª∫Âú∞ÂùÄÁªÑ‰ª∂ÂÆû‰æã
    vietnameseAddressComponent = new VietnameseAddressComponent({
        apiKey: '5uo0DOu7oFhOoqtxFhyZemwhmkI0XiFTiq66c0Nj',
        apiBaseUrl: '/api/goong-address',
        mapContainer: 'vietnamese-address-map',
        autocompleteContainer: 'vietnamese-address-autocomplete',
        defaultCenter: [106.6297, 10.8231], // Ho Chi Minh City
        defaultZoom: 12
    });
    
    // ÁõëÂê¨Âú∞ÂùÄÈÄâÊã©‰∫ã‰ª∂
    document.addEventListener('vietnameseAddressSelected', function(event) {
        const addressData = event.detail;
        updateVietnameseAddressForm(addressData);
        updateAddressPreview(addressData);
    });
}

/**
 * Êõ¥Êñ∞Ë∂äÂçóÂú∞ÂùÄË°®Âçï
 */
function updateVietnameseAddressForm(addressData) {
    if (!addressData || !addressData.vietnamese_address) return;
    
    const vietnameseAddr = addressData.vietnamese_address;
    
    // Â°´ÂÖÖÂú∞ÂùÄÂ≠óÊÆµ
    if (vietnameseAddr.province) {
        $('.vietnamese-province').val(vietnameseAddr.province);
    }
    
    if (vietnameseAddr.district) {
        $('.vietnamese-district').val(vietnameseAddr.district);
    }
    
    if (vietnameseAddr.ward) {
        $('.vietnamese-ward').val(vietnameseAddr.ward);
    }
    
    if (vietnameseAddr.street) {
        $('.vietnamese-street').val(vietnameseAddr.street);
    }
    
    if (vietnameseAddr.house_number) {
        $('.vietnamese-house-number').val(vietnameseAddr.house_number);
    }
    
    // Â°´ÂÖÖÂÆåÊï¥Âú∞ÂùÄ
    if (addressData.formatted_address) {
        $('.vietnamese-detail').val(addressData.formatted_address);
    }
    
    // ‰øùÂ≠òÂùêÊ†á
    if (addressData.geometry && addressData.geometry.location) {
        $('#latitude').val(addressData.geometry.location.lat);
        $('#longitude').val(addressData.geometry.location.lng);
    }
    
    // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
    showSuccessMessage('ƒê√£ ch·ªçn ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
}

/**
 * Êõ¥Êñ∞Âú∞ÂùÄÈ¢ÑËßà
 */
function updateAddressPreview(addressData) {
    const previewCard = $('#vietnamese-address-preview');
    const previewContent = $('#vietnamese-preview-content');
    
    if (addressData) {
        const vietnameseAddr = addressData.vietnamese_address || {};
        
        const previewHtml = `
            <div class="row">
                <div class="col-md-8">
                    <h6>ƒê·ªãa ch·ªâ ƒë√£ ch·ªçn:</h6>
                    <p class="mb-2"><strong>${addressData.formatted_address || 'N/A'}</strong></p>
                    
                    <h6>Ph√¢n t√≠ch chi ti·∫øt:</h6>
                    <div class="row">
                        <div class="col-sm-6">
                            <ul class="list-unstyled">
                                ${vietnameseAddr.province ? `<li><strong>T·ªânh/TP:</strong> ${vietnameseAddr.province}</li>` : ''}
                                ${vietnameseAddr.district ? `<li><strong>Qu·∫≠n/Huy·ªán:</strong> ${vietnameseAddr.district}</li>` : ''}
                                ${vietnameseAddr.ward ? `<li><strong>Ph∆∞·ªùng/X√£:</strong> ${vietnameseAddr.ward}</li>` : ''}
                            </ul>
                        </div>
                        <div class="col-sm-6">
                            <ul class="list-unstyled">
                                ${vietnameseAddr.street ? `<li><strong>ƒê∆∞·ªùng:</strong> ${vietnameseAddr.street}</li>` : ''}
                                ${vietnameseAddr.house_number ? `<li><strong>S·ªë nh√†:</strong> ${vietnameseAddr.house_number}</li>` : ''}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    ${addressData.geometry && addressData.geometry.location ? `
                        <h6>T·ªça ƒë·ªô:</h6>
                        <p>
                            <strong>Vƒ© ƒë·ªô:</strong> ${addressData.geometry.location.lat}<br>
                            <strong>Kinh ƒë·ªô:</strong> ${addressData.geometry.location.lng}
                        </p>
                    ` : ''}
                </div>
            </div>
        `;
        
        previewContent.html(previewHtml);
        previewCard.show();
    } else {
        previewCard.hide();
    }
}

/**
 * Ê∏ÖÁ©∫Ë∂äÂçóÂú∞ÂùÄ
 */
function clearVietnameseAddress() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ th√¥ng tin ƒë·ªãa ch·ªâ?')) {
        // Ê∏ÖÁ©∫Ë°®Âçï
        $('#vietnameseAddressForm')[0].reset();
        
        // Ê∏ÖÁ©∫Âú∞ÂùÄÁªÑ‰ª∂
        if (vietnameseAddressComponent) {
            vietnameseAddressComponent.clearAddress();
        }
        
        // ÈöêËóèÈ¢ÑËßà
        $('#vietnamese-address-preview').hide();
        
        // ÈáçÁΩÆÂõΩÂÆ∂ÈÄâÊã©‰∏∫Ë∂äÂçó
        $('select[name="address[country_id]"]').val('1');
        
        showSuccessMessage('ƒê√£ x√≥a th√¥ng tin ƒë·ªãa ch·ªâ!');
    }
}

/**
 * ÁªëÂÆöË°®ÂçïÊèê‰∫§‰∫ã‰ª∂
 */
function bindFormSubmitEvent() {
    $(".address").click(function(e) {
        e.preventDefault();
        
        var formData = getFormData();
        
        // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
        if (!validateVietnameseAddressForm(formData)) {
            return;
        }
        
        // Êèê‰∫§Âú∞ÂùÄ
        submitVietnameseAddress(formData);
    });
}

/**
 * Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
 */
function getFormData() {
     var formJson = {};
    var formArray = $('#vietnameseAddressForm').serializeArray();
    
    $.each(formArray, function(i, field) {
        formJson[field.name] = field.value;
    });
    
    return formJson;
}

/**
 * È™åËØÅË∂äÂçóÂú∞ÂùÄË°®Âçï
 */
function validateVietnameseAddressForm(formData) {
    // È™åËØÅÊî∂‰ª∂‰∫∫ÂßìÂêç
    if (!formData['address[name]'] || formData['address[name]'].trim() === '') {
        showErrorMessage('Vui l√≤ng nh·∫≠p h·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n!');
        return false;
    }
    
    // È™åËØÅÁîµËØùÂè∑Á†Å
    if (!formData['address[phone]'] || formData['address[phone]'].trim() === '') {
        showErrorMessage('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!');
        return false;
    }
    
    // È™åËØÅÁúÅ‰ªΩ
    if (!formData['address[province]'] || formData['address[province]'].trim() === '') {
        showErrorMessage('Vui l√≤ng ch·ªçn T·ªânh/Th√†nh ph·ªë!');
        return false;
    }
    
    // È™åËØÅÂå∫Âéø
    if (!formData['address[city]'] || formData['address[city]'].trim() === '') {
        showErrorMessage('Vui l√≤ng ch·ªçn Qu·∫≠n/Huy·ªán!');
        return false;
    }
    
    // È™åËØÅÂùä/Á§æ
    if (!formData['address[region]'] || formData['address[region]'].trim() === '') {
        showErrorMessage('Vui l√≤ng ch·ªçn Ph∆∞·ªùng/X√£!');
         return false;
     }
     
    // È™åËØÅËØ¶ÁªÜÂú∞ÂùÄ
    if (!formData['address[detail]'] || formData['address[detail]'].trim() === '') {
        showErrorMessage('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt!');
         return false;
     }
    
    return true;
}

/**
 * Êèê‰∫§Ë∂äÂçóÂú∞ÂùÄ
 */
function submitVietnameseAddress(formData) {
    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    var submitButton = $('.address');
    var originalText = submitButton.text();
    submitButton.prop('disabled', true).text('ƒêang l∆∞u...');
    
    var url = "<?php echo(urlCreate('/web/user/address')) ?>";

     $.ajax({
        type: 'POST',
        url: url,
        data: formData,
        dataType: 'json',
        success: function(response) {
            if (response.code === 1) {
                showSuccessMessage('L∆∞u ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
                
                // Âª∂ËøüË∑≥ËΩ¨
                setTimeout(function() {
                    var redirectUrl = "<?php echo(urlCreate('/web/user/address')) ?>";
                    window.location.href = redirectUrl;
                }, 1500);
            } else {
                showErrorMessage(response.msg || 'L·ªói khi l∆∞u ƒë·ªãa ch·ªâ!');
        }
        },
        error: function() {
            showErrorMessage('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!');
        },
        complete: function() {
            // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
            submitButton.prop('disabled', false).text(originalText);
        }
    });
}

/**
 * ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
 */
function showSuccessMessage(message) {
    // ÂèØ‰ª•‰ΩøÁî®Áé∞ÊúâÁöÑÈÄöÁü•Á≥ªÁªüÊàñÁÆÄÂçïÁöÑalert
    if (typeof toastr !== 'undefined') {
        toastr.success(message);
    } else {
        alert(message);
    }
}

/**
 * ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
 */
function showErrorMessage(message) {
    // ÂèØ‰ª•‰ΩøÁî®Áé∞ÊúâÁöÑÈÄöÁü•Á≥ªÁªüÊàñÁÆÄÂçïÁöÑalert
    if (typeof toastr !== 'undefined') {
        toastr.error(message);
    } else {
        alert(message);
    }
}
</script>						

<style>
/* Ë∂äÂçóÂú∞ÂùÄË°®ÂçïÊ†∑Âºè */
.vietnamese-province,
.vietnamese-district,
.vietnamese-ward {
    background-color: #f8f9fa;
    cursor: pointer;
}

.vietnamese-province:focus,
.vietnamese-district:focus,
.vietnamese-ward:focus {
    background-color: #fff;
}

.autocomplete-container {
    position: relative;
}

.address-suggestions {
    position: absolute;
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    width: 100%;
}

.address-suggestion-item .main-text {
    font-weight: 500;
    color: #333;
}

.address-suggestion-item .secondary-text {
    font-size: 0.85em;
    color: #666;
    margin-top: 2px;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

#vietnamese-address-map {
    width: 100%;
    height: 300px;
}

.form-section {
    border-left: 4px solid #007bff;
}

.required {
    color: red;
}
</style>						
						